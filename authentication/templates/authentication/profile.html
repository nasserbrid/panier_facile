{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h2 class="mb-4"><i class="fas fa-user-circle"></i> Mon Profil</h2>

            <!-- Informations utilisateur -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Informations personnelles</h5>
                </div>
                <div class="card-body">
                    <p><strong>Nom d'utilisateur:</strong> {{ user.username }}</p>
                    <p class="mb-0"><strong>Email:</strong> {{ user.email }}</p>
                </div>
            </div>

            <!-- Section Géolocalisation -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-map-marker-alt"></i> Ma Localisation</h5>
                </div>
                <div class="card-body">
                    <!-- Messages de statut -->
                    <div id="locationMessage" class="alert" style="display: none;"></div>

                    <!-- Localisation actuelle -->
                    {% if location_data %}
                    <div class="alert alert-info">
                        <h6><i class="fas fa-check-circle"></i> Localisation enregistrée</h6>
                        {% if location_data.address %}
                        <p class="mb-1"><strong>Adresse:</strong> {{ location_data.address }}</p>
                        {% endif %}
                        <p class="mb-0">
                            <strong>Coordonnées:</strong>
                            Lat: {{ location_data.latitude|floatformat:6 }},
                            Long: {{ location_data.longitude|floatformat:6 }}
                        </p>
                    </div>
                    {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> Aucune localisation enregistrée
                    </div>
                    {% endif %}

                    <!-- Bouton de géolocalisation automatique -->
                    <div class="mb-3">
                        <button id="getLocationBtn" class="btn btn-primary btn-lg w-100">
                            <i class="fas fa-crosshairs"></i> Détecter ma position GPS
                        </button>
                        <small class="form-text text-muted">
                            Utilisez le GPS de votre appareil pour détecter automatiquement votre position
                        </small>
                    </div>

                    <div class="text-center my-3">
                        <strong>OU</strong>
                    </div>

                    <!-- Formulaire d'adresse manuelle -->
                    <div>
                        <label for="addressInput" class="form-label">
                            <i class="fas fa-map-marked-alt"></i> Entrer une adresse manuellement
                        </label>
                        <div class="input-group mb-3">
                            <input
                                type="text"
                                id="addressInput"
                                class="form-control"
                                placeholder="Ex: 10 Rue de la Paix, Paris"
                                {% if location_data.address %}value="{{ location_data.address }}"{% endif %}
                            >
                            <button id="geocodeBtn" class="btn btn-secondary">
                                <i class="fas fa-search"></i> Rechercher
                            </button>
                        </div>
                        {% comment %} <small class="form-text text-muted">
                            Nous utilisons Nominatim (OpenStreetMap) pour géocoder l'adresse
                        </small> {% endcomment %}
                    </div>

                    <!-- Coordonnées manuelles (optionnel, pour debug) -->
                    <div class="mt-3">
                        <details>
                            <summary class="text-muted" style="cursor: pointer;">
                                <small>Coordonnées manuelles (avancé)</small>
                            </summary>
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <label for="latInput">Latitude</label>
                                    <input
                                        type="number"
                                        id="latInput"
                                        class="form-control form-control-sm"
                                        step="0.000001"
                                        placeholder="48.856614"
                                        {% if location_data %}value="{{ location_data.latitude }}"{% endif %}
                                    >
                                </div>
                                <div class="col-md-6">
                                    <label for="lngInput">Longitude</label>
                                    <input
                                        type="number"
                                        id="lngInput"
                                        class="form-control form-control-sm"
                                        step="0.000001"
                                        placeholder="2.352222"
                                        {% if location_data %}value="{{ location_data.longitude }}"{% endif %}
                                    >
                                </div>
                            </div>
                            <button id="saveManualBtn" class="btn btn-sm btn-secondary mt-2">
                                Sauvegarder ces coordonnées
                            </button>
                        </details>
                    </div>
                </div>
            </div>

            <!-- Lien vers la recherche de commerces -->
            {% if location_data %}
            <div class="card mb-4 border-success">
                <div class="card-body text-center">
                    <h5><i class="fas fa-store"></i> Commerces à proximité</h5>
                    <p class="text-muted">Trouvez les épiceries, boucheries, et supermarchés près de chez vous</p>
                    <a href="{% url 'nearby_stores' %}" class="btn btn-success">
                        <i class="fas fa-search-location"></i> Voir les commerces proches
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- Lien retour -->
            <div class="text-center mt-4">
                <a href="{% url 'home' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i> Retour à l'accueil
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Script de géolocalisation -->
<script>
    const saveLocationUrl = "{% url 'save_location' %}";
    const csrfToken = "{{ csrf_token }}";

    // Fonction pour afficher un message
    function showMessage(message, type) {
        const messageDiv = document.getElementById('locationMessage');
        messageDiv.className = `alert alert-${type}`;
        messageDiv.textContent = message;
        messageDiv.style.display = 'block';

        setTimeout(() => {
            messageDiv.style.display = 'none';
        }, 5000);
    }

    // Fonction pour sauvegarder la localisation via l'API
    async function saveLocation(latitude, longitude, address = '') {
        try {
            const response = await fetch(saveLocationUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    latitude: latitude,
                    longitude: longitude,
                    address: address
                })
            });

            const data = await response.json();

            if (data.success) {
                showMessage('✓ ' + data.message, 'success');
                // Recharger la page après 2 secondes pour afficher les nouvelles données
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                showMessage('✗ ' + data.message, 'danger');
            }
        } catch (error) {
            showMessage('✗ Erreur de connexion: ' + error.message, 'danger');
        }
    }

    // Géolocalisation automatique GPS
    document.getElementById('getLocationBtn').addEventListener('click', function() {
        if (!navigator.geolocation) {
            showMessage('✗ La géolocalisation n\'est pas supportée par votre navigateur', 'danger');
            return;
        }

        showMessage('⏳ Détection de votre position en cours...', 'info');

        navigator.geolocation.getCurrentPosition(
            async function(position) {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;

                // Reverse geocoding pour obtenir l'adresse (optionnel)
                let address = '';
                try {
                    const geoResponse = await fetch(
                        `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`,
                        {
                            headers: {
                                'User-Agent': 'PanierFacile/1.0'
                            }
                        }
                    );
                    const geoData = await geoResponse.json();
                    address = geoData.display_name || '';
                } catch (e) {
                    console.log('Reverse geocoding failed:', e);
                }

                await saveLocation(latitude, longitude, address);
            },
            function(error) {
                let errorMessage = '';
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = 'Vous avez refusé l\'accès à votre position';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = 'Position non disponible';
                        break;
                    case error.TIMEOUT:
                        errorMessage = 'La demande a expiré';
                        break;
                    default:
                        errorMessage = 'Erreur inconnue';
                }
                showMessage('✗ ' + errorMessage, 'danger');
            }
        );
    });

    // Geocoding d'une adresse
    document.getElementById('geocodeBtn').addEventListener('click', async function() {
        const address = document.getElementById('addressInput').value.trim();

        if (!address) {
            showMessage('✗ Veuillez entrer une adresse', 'warning');
            return;
        }

        showMessage('⏳ Recherche de l\'adresse en cours...', 'info');

        try {
            const response = await fetch(
                `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`,
                {
                    headers: {
                        'User-Agent': 'PanierFacile/1.0'
                    }
                }
            );
            const data = await response.json();

            if (data.length > 0) {
                const latitude = parseFloat(data[0].lat);
                const longitude = parseFloat(data[0].lon);
                const displayName = data[0].display_name;

                await saveLocation(latitude, longitude, displayName);
            } else {
                showMessage('✗ Adresse introuvable. Vérifiez l\'orthographe.', 'warning');
            }
        } catch (error) {
            showMessage('✗ Erreur lors de la recherche: ' + error.message, 'danger');
        }
    });

    // Sauvegarde manuelle des coordonnées
    document.getElementById('saveManualBtn').addEventListener('click', function() {
        const latitude = parseFloat(document.getElementById('latInput').value);
        const longitude = parseFloat(document.getElementById('lngInput').value);

        if (isNaN(latitude) || isNaN(longitude)) {
            showMessage('✗ Coordonnées invalides', 'danger');
            return;
        }

        if (latitude < -90 || latitude > 90 || longitude < -180 || longitude > 180) {
            showMessage('✗ Coordonnées hors limites', 'danger');
            return;
        }

        saveLocation(latitude, longitude, document.getElementById('addressInput').value);
    });

    // Permettre la recherche avec Enter
    document.getElementById('addressInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('geocodeBtn').click();
        }
    });
</script>
{% endblock %}
