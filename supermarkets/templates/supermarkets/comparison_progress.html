{% extends 'base.html' %}
{% load static %}

{% block title %}Comparaison en cours...{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card">
                <div class="card-body text-center py-5">
                    <div class="spinner-border text-primary mb-4" role="status" style="width: 4rem; height: 4rem;">
                        <span class="visually-hidden">Chargement...</span>
                    </div>

                    <h3 class="mb-3">Comparaison des prix en cours</h3>

                    <p class="text-muted mb-4" id="statusMessage">
                        Recherche des meilleurs prix...
                    </p>

                    <!-- Barre de progression globale -->
                    <div class="progress mb-4" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                             role="progressbar"
                             id="progressBar"
                             style="width: 0%"
                             aria-valuenow="0"
                             aria-valuemin="0"
                             aria-valuemax="100">
                            0%
                        </div>
                    </div>

                    <!-- Status par supermarche -->
                    <div class="row text-start mb-4">
                        <div class="col-6">
                            <div class="d-flex align-items-center">
                                <span class="spinner-grow spinner-grow-sm text-primary me-2" id="carrefourSpinner"></span>
                                <span id="carrefourStatus">Carrefour en attente...</span>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="d-flex align-items-center">
                                <span class="spinner-grow spinner-grow-sm text-secondary me-2" id="auchanSpinner"></span>
                                <span id="auchanStatus">Auchan en attente...</span>
                            </div>
                        </div>
                    </div>

                    <p class="small text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Ne fermez pas cette page. La comparaison peut prendre plusieurs minutes.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const taskId = "{{ task_id }}";
const panierId = {{ panier.id }};
let pollInterval;

function updateProgress(data) {
    const progressBar = document.getElementById('progressBar');
    const statusMessage = document.getElementById('statusMessage');

    if (data.progress) {
        const percent = Math.round((data.progress.current / data.progress.total) * 100);
        progressBar.style.width = percent + '%';
        progressBar.textContent = percent + '%';
        progressBar.setAttribute('aria-valuenow', percent);

        statusMessage.textContent = data.progress.message || 'Recherche en cours...';

        // Mettre a jour les status par supermarche
        if (data.progress.supermarket === 'carrefour') {
            document.getElementById('carrefourStatus').textContent = 'Carrefour: recherche...';
            document.getElementById('carrefourSpinner').classList.remove('text-secondary');
            document.getElementById('carrefourSpinner').classList.add('text-primary');
        } else if (data.progress.supermarket === 'auchan') {
            document.getElementById('carrefourStatus').innerHTML = '<i class="fas fa-check text-success me-1"></i>Carrefour termine';
            document.getElementById('carrefourSpinner').style.display = 'none';
            document.getElementById('auchanStatus').textContent = 'Auchan: recherche...';
            document.getElementById('auchanSpinner').classList.remove('text-secondary');
            document.getElementById('auchanSpinner').classList.add('text-primary');
        }
    }
}

function pollStatus() {
    fetch('/panier/api/comparison-status/' + taskId + '/')
        .then(response => response.json())
        .then(data => {
            console.log('Status:', data);

            if (data.state === 'PROGRESS') {
                updateProgress(data);
            } else if (data.state === 'SUCCESS' && data.result && data.result.comparison_id) {
                clearInterval(pollInterval);
                document.getElementById('progressBar').style.width = '100%';
                document.getElementById('progressBar').textContent = '100%';
                document.getElementById('statusMessage').textContent = 'Comparaison terminee! Redirection...';

                // Rediriger vers les resultats
                window.location.href = '/panier/' + panierId + '/comparer/resultats/' + data.result.comparison_id + '/';
            } else if (data.state === 'FAILURE') {
                clearInterval(pollInterval);
                document.getElementById('statusMessage').innerHTML = '<span class="text-danger">Erreur lors de la comparaison. Veuillez reessayer.</span>';
                document.querySelector('.spinner-border').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Erreur polling:', error);
        });
}

// Demarrer le polling
pollInterval = setInterval(pollStatus, 2000);
pollStatus(); // Premier appel immediat
</script>
{% endblock %}
