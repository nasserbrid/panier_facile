name: Daily Notifications

on:
  schedule:
    # Notifications matin Ã  8h00 (heure de Paris)
    - cron: "0 7 * * *" # 7h UTC = 8h Paris (hiver) / 6h UTC = 8h Paris (Ã©tÃ©)
    # Notifications soir Ã  18h00 (heure de Paris)
    - cron: "0 17 * * *" # 17h UTC = 18h Paris (hiver) / 16h UTC = 18h Paris (Ã©tÃ©)
  workflow_dispatch: # Permet de lancer manuellement pour tester

jobs:
  send-notifications:
    runs-on: ubuntu-latest

    steps:
      - name: Wake up application
        run: |
          echo "ğŸš€ RÃ©veil de l'application Render..."

          # Ping le health check pour rÃ©veiller l'app
          for i in {1..5}
          do
            echo "Wake-up tentative $i/5"
            response=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 \
              https://panier-facile.onrender.com/health/)
            
            echo "Health check retournÃ©: $response"
            
            if [ $response -eq 200 ]; then
              echo "âœ… Application rÃ©veillÃ©e avec succÃ¨s"
              break
            else
              echo "â³ Application en dÃ©marrage... attente 15 secondes"
              sleep 15
            fi
          done

      - name: Wait for app to be fully ready
        run: |
          echo "â³ Attente que l'application soit complÃ¨tement prÃªte..."
          sleep 10

      - name: Trigger notifications with retries
        env:
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
        run: |
          echo "ğŸ“§ DÃ©clenchement des notifications..."

          # Tentatives multiples avec dÃ©lais progressifs
          for attempt in {1..5}
          do
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "Tentative $attempt/5"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            
            response=$(curl -s -w "\n%{http_code}" --max-time 30 \
              -H "X-CRON-TOKEN: $CRON_TOKEN" \
              -H "User-Agent: GitHub Actions Notification" \
              -H "Accept: application/json" \
              https://panier-facile.onrender.com/trigger-notification/)
            
            # SÃ©parer le corps de la rÃ©ponse et le code HTTP
            http_body=$(echo "$response" | head -n -1)
            http_code=$(echo "$response" | tail -n 1)
            
            echo "Code HTTP: $http_code"
            echo "RÃ©ponse: $http_body"
            
            if [ "$http_code" -eq 200 ]; then
              echo "âœ… Notifications envoyÃ©es avec succÃ¨s!"
              exit 0
            else
              echo "âŒ Ã‰chec (code $http_code)"
              
              if [ $attempt -lt 5 ]; then
                # DÃ©lai progressif: 15s, 20s, 25s, 30s
                delay=$((15 + (attempt * 5)))
                echo "â³ Nouvelle tentative dans ${delay}s..."
                sleep $delay
              fi
            fi
          done

          echo ""
          echo "âŒ Ã‰chec aprÃ¨s 5 tentatives"
          exit 1

      - name: Notify on failure
        if: failure()
        run: |
          echo "âš ï¸ Les notifications ont Ã©chouÃ© aprÃ¨s toutes les tentatives"
          echo "Consultez les logs GitHub Actions pour plus de dÃ©tails"
