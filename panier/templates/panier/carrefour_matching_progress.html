{% extends 'base.html' %}
{% load static %}

{% block title %}Préparation de votre panier Carrefour - PanierFacile{% endblock %}

{% block content %}
<div class="container">
    {% if task_state == 'PENDING' or task_state == 'STARTED' %}
    <!-- En cours de traitement -->
    <div class="progress-container">
        <h2 class="text-primary mb-4">
            <i class="bi bi-cart-check"></i> Préparation de votre panier Carrefour en cours...
        </h2>

        <div class="spinner-container">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
        </div>

        <p class="lead text-muted mb-4">
            Nous recherchons les meilleurs produits Carrefour pour vous.
            <br>Cette opération peut prendre quelques minutes.
        </p>

        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            Vous pouvez fermer cette page, nous vous notifierons quand ce sera prêt.
        </div>

        <!-- Hidden data for JavaScript -->
        <div id="task-status" data-status="{{ task_state }}" data-task-id="{{ task_id }}" style="display: none;"></div>
    </div>

    {% elif task_state == 'SUCCESS' %}
    <!-- Tâche terminée avec succès -->
    <div class="results-card">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'liste_paniers' %}">Mes paniers</a></li>
                <li class="breadcrumb-item"><a href="{% url 'detail_panier' panier.id %}">Panier {{ panier.id }}</a></li>
                <li class="breadcrumb-item active">Résultats du matching Carrefour</li>
            </ol>
        </nav>

        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h3 class="mb-0">
                    <i class="bi bi-check-circle"></i> Recherche Carrefour terminée !
                </h3>
            </div>
            <div class="card-body">
                <div class="stat-box text-center">
                    <p class="mb-2">Produits trouvés</p>
                    <h3>{{ matched_count }}/{{ total_count }}</h3>
                    <div class="progress mt-3">
                        <div class="progress-bar bg-success" role="progressbar"
                             style="width: {{ success_rate }}%;"
                             aria-valuenow="{{ success_rate }}"
                             aria-valuemin="0"
                             aria-valuemax="100">
                            {{ success_rate|floatformat:0 }}%
                        </div>
                    </div>
                </div>

                {% if matched_count > 0 %}
                <div class="alert alert-success mt-4">
                    <i class="bi bi-cart-check"></i>
                    Nous avons trouvé {{ matched_count }} produit(s) Carrefour correspondant à vos ingrédients !
                </div>

                <div class="d-grid gap-2 mt-4">
                    <a href="{% url 'carrefour_create_cart' panier.id %}?store_id={{ store_id }}"
                       class="btn btn-lg btn-primary">
                        <i class="bi bi-box-arrow-up-right"></i>
                        Voir mon panier Carrefour
                    </a>
                    <a href="{% url 'detail_panier' panier.id %}"
                       class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i>
                        Retour au panier
                    </a>
                </div>
                {% else %}
                <div class="alert alert-warning mt-4">
                    <i class="bi bi-exclamation-triangle"></i>
                    Aucun produit Carrefour trouvé. Essayez de reformuler vos ingrédients.
                </div>

                <div class="d-grid gap-2 mt-4">
                    <a href="{% url 'detail_panier' panier.id %}"
                       class="btn btn-outline-primary">
                        <i class="bi bi-arrow-left"></i>
                        Retour au panier
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    {% elif task_state == 'FAILURE' %}
    <!-- Erreur -->
    <div class="progress-container">
        <div class="alert alert-danger">
            <h4 class="alert-heading">
                <i class="bi bi-x-circle"></i> Une erreur est survenue
            </h4>
            <p>{{ error }}</p>
            <hr>
            <p class="mb-0">
                <a href="{% url 'select_store_for_drive' panier.id %}" class="btn btn-outline-danger">
                    <i class="bi bi-arrow-clockwise"></i> Réessayer
                </a>
            </p>
        </div>
    </div>

    {% else %}
    <!-- État inconnu -->
    <div class="progress-container">
        <div class="alert alert-warning">
            <h4 class="alert-heading">État inconnu</h4>
            <p>Statut de la tâche : {{ task_state }}</p>
            <a href="{% url 'select_store_for_drive' panier.id %}" class="btn btn-outline-warning">
                Retour à la sélection du magasin
            </a>
        </div>
    </div>
    {% endif %}
</div>

<!-- Auto-refresh script -->
<script>
    // Auto-refresh every 3 seconds if task is pending or started
    const taskStatus = document.getElementById('task-status');
    if (taskStatus) {
        const status = taskStatus.dataset.status;
        if (status === 'PENDING' || status === 'STARTED') {
            setTimeout(() => {
                location.reload();
            }, 3000);
        }
    }
</script>
{% endblock %}
